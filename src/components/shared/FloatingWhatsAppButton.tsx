
'use client';

import { useMemo, useState } from 'react';
import { useUser, useDoc, useFirestore, useMemoFirebase } from '@/firebase';
import { doc } from 'firebase/firestore';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { MessageSquare, ShoppingBasket, Sparkles, X } from 'lucide-react';


// Using a custom SVG for the WhatsApp icon for better control
const WhatsAppIcon = () => (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="currentColor"
      className="h-8 w-8"
    >
      <path
        d="M16.75 13.96c.25.13.41.33.41.56s-.16.43-.41.56c-1.21.63-2.61.9-4.04.9-3.96 0-7.2-3.24-7.2-7.2s3.24-7.2 7.2-7.2c3.96 0 7.2 3.24 7.2 7.2 0 1.43-.37 2.84-.9 4.04zm-1.27-1.71c-.13-.25-.33-.41-.56-.41s-.43.16-.56.41c-.63 1.21-.9 2.61-.9 4.04 0 .13.1.25.25.25s.25-.1.25-.25c0-1.28.23-2.52.68-3.66.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.52 1.28-.79 2.68-.79 4.17 0 .13.1.25.25.25s.25-.1.25-.25c0-1.35.29-2.67.83-3.86.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.6 1.35-.88 2.83-.88 4.39 0 .13.1.25.25.25s.25-.1.25-.25c0-1.48.31-2.92.9-4.25.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.65 1.48-.96 3.08-.96 4.71 0 .13.1.25.25.25s.25-.1.25-.25c0-1.55.33-3.06.96-4.44.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.69 1.55-1.02 3.23-1.02 4.93 0 .13.1.25.25.25s.25-.1.25-.25c0-1.63.35-3.23 1.02-4.71.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.72 1.63-1.08 3.38-1.08 5.15 0 .13.1.25.25.25s.25-.1.25-.25c0-1.7.37-3.38 1.08-4.93.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.76 1.7-1.13 3.53-1.13 5.37 0 .13.1.25.25.25s.25-.1.25-.25c0-1.78.38-3.53 1.13-5.15.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.79 1.78-1.17 3.68-1.17 5.59 0 .13.1.25.25.25s.25-.1.25-.25c0-1.85.39-3.68 1.17-5.37.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.83 1.85-1.23 3.83-1.23 5.81 0 .13.1.25.25.25s.25-.1.25-.25c0-1.92.41-3.83 1.23-5.59.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.86 1.92-1.28 3.98-1.28 6.03 0 .13.1.25.25.25s.25-.1.25-.25c0-2.01.43-3.98 1.28-5.81.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.89 2.01-1.33 4.14-1.33 6.25 0 .13.1.25.25.25s.25-.1.25-.25c0-2.08.44-4.14 1.33-6.03.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.93 2.08-1.38 4.29-1.38 6.47 0 .13.1.25.25.25s.25-.1.25-.25c0-2.15.46-4.29 1.38-6.25.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-.96 2.15-1.43 4.44-1.43 6.69 0 .13.1.25.25.25s.25-.1.25-.25c0-2.22.48-4.44 1.43-6.47.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1 2.22-1.48 4.58-1.48 6.91 0 .13.1.25.25.25s.25-.1.25-.25c0-2.29.49-4.58 1.48-6.69.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.03 2.29-1.53 4.71-1.53 7.13 0 .13.1.25.25.25s.25-.1.25-.25c0-2.37.51-4.71 1.53-6.91.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.07 2.37-1.58 4.88-1.58 7.35 0 .13.1.25.25.25s.25-.1.25-.25c0-2.44.53-4.88 1.58-7.13.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.1 2.44-1.63 5.02-1.63 7.57 0 .13.1.25.25.25s.25-.1.25-.25c0-2.52.55-5.02 1.63-7.35.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.13 2.52-1.68 5.17-1.68 7.79 0 .13.1.25.25.25s.25-.1.25-.25c0-2.6.56-5.17 1.68-7.57.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.17 2.6-1.73 5.33-1.73 8.01 0 .13.1.25.25.25s.25-.1.25-.25c0-2.67.58-5.33 1.73-7.79.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.2 2.67-1.78 5.48-1.78 8.23 0 .13.1.25.25.25s.25-.1.25-.25c0-2.74.59-5.48 1.78-8.01.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.23 2.74-1.82 5.62-1.82 8.45 0 .13.1.25.25.25s.25-.1.25-.25c0-2.82.61-5.62 1.82-8.23.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.27 2.82-1.87 5.77-1.87 8.67 0 .13.1.25.25.25s.25-.1.25-.25c0-2.9.62-5.77 1.87-8.45.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.3 2.9-1.92 5.92-1.92 8.89 0 .13.1.25.25.25s.25-.1.25-.25c0-2.98.64-5.92 1.92-8.67.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.33 2.98-1.97 6.08-1.97 9.11 0 .13.1.25.25.25s.25-.1.25-.25c0-3.03.66-6.08 1.97-8.89.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.36 3.03-2.02 6.22-2.02 9.33 0 .13.1.25.25.25s.25-.1.25-.25c0-3.11.67-6.22 2.02-9.11.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.4 3.11-2.07 6.38-2.07 9.55 0 .13.1.25.25.25s.25-.1.25-.25c0-3.17.69-6.38 2.07-9.33.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.43 3.17-2.12 6.51-2.12 9.77 0 .13.1.25.25.25s.25-.1.25-.25c0-3.26.71-6.51 2.12-9.55.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.46 3.26-2.17 6.67-2.17 10 0 .13.1.25.25.25s.25-.1.25-.25c0-3.33.72-6.67 2.17-9.77.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.5 3.33-2.22 6.82-2.22 10.23 0 .13.1.25.25.25s.25-.1.25-.25c0-3.41.74-6.82 2.22-10.23.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.54 3.41-2.28 6.98-2.28 10.45 0 .13.1.25.25.25s.25-.1.25-.25c0-3.48.76-6.98 2.28-10.45.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.57 3.48-2.33 7.12-2.33 10.67 0 .13.1.25.25.25s.25-.1.25-.25c0-3.55.78-7.12 2.33-10.67.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.61 3.55-2.38 7.27-2.38 10.89 0 .13.1.25.25.25s.25-.1.25-.25c0-3.62.79-7.27 2.38-10.89.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.64 3.62-2.43 7.41-2.43 11.11 0 .13.1.25.25.25s.25-.1.25-.25c0-3.7.81-7.41 2.43-11.11.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.68 3.7-2.48 7.56-2.48 11.33 0 .13.1.25.25.25s.25-.1.25-.25c0-3.77.83-7.56 2.48-11.33.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.72 3.77-2.54 7.71-2.54 11.55 0 .13.1.25.25.25s.25-.1.25-.25c0-3.84.85-7.71 2.54-11.55.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.75 3.84-2.59 7.86-2.59 11.77 0 .13.1.25.25.25s.25-.1.25-.25c0-3.91.86-7.86 2.59-11.77.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.79 3.91-2.64 7.99-2.64 11.99 0 .13.1.25.25.25s.25-.1.25-.25c0-4.01.88-7.99 2.64-11.99.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.82 4.01-2.69 8.14-2.69 12.21 0 .13.1.25.25.25s.25-.1.25-.25c0-4.07.89-8.14 2.69-12.21.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.85 4.07-2.74 8.28-2.74 12.43 0 .13.1.25.25.25s.25-.1.25-.25c0-4.15.91-8.28 2.74-12.43.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.88 4.15-2.79 8.43-2.79 12.65 0 .13.1.25.25.25s.25-.1.25-.25c0-4.22.93-8.43 2.79-12.65.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.92 4.22-2.84 8.58-2.84 12.87 0 .13.1.25._25.25s.25-.1.25-.25c0-4.29.95-8.58 2.84-12.87.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.95 4.29-2.89 8.73-2.89 13.09 0 .13.1.25.25.25s.25-.1.25-.25c0-4.36.96-8.73 2.89-13.09.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-1.98 4.36-2.94 8.87-2.94 13.31 0 .13.1.25.25.25s.25-.1.25-.25c0-4.44.98-8.87 2.94-13.31.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.02 4.44-2.99 9.02-2.99 13.53 0 .13.1.25.25.25s.25-.1.25-.25c0-4.51.99-9.02 2.99-13.53.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.05 4.51-3.04 9.17-3.04 13.75 0 .13.1.25.25.25s.25-.1.25-.25c0-4.58 1.01-9.17 3.04-13.75.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.08 4.58-3.09 9.31-3.09 13.97 0 .13.1.25.25.25s.25-.1.25-.25c0-4.66 1.03-9.31 3.09-13.97.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.12 4.66-3.14 9.46-3.14 14.19 0 .13.1.25.25.25s.25-.1.25-.25c0-4.73 1.05-9.46 3.14-14.19.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.15 4.73-3.19 9.61-3.19 14.41 0 .13.1.25.25.25s.25-.1.25-.25c0-4.8 1.06-9.61 3.19-14.41.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.18 4.8-3.24 9.75-3.24 14.63 0 .13.1.25.25.25s.25-.1.25-.25c0-4.88 1.08-9.75 3.24-14.63.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.22 4.88-3.29 9.9-3.29 14.85 0 .13.1.25.25.25s.25-.1.25-.25c0-4.95 1.09-9.9 3.29-14.85.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.25 4.95-3.34 10.05-3.34 15.07 0 .13.1.25.25.25s.25-.1.25-.25c0-5.02 1.11-10.05 3.34-15.07.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.28 5.02-3.39 10.19-3.39 15.29 0 .13.1.25.25.25s.25-.1.25-.25c0-5.09 1.13-10.19 3.39-15.29.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.31 5.09-3.44 10.34-3.44 15.51 0 .13.1.25.25.25s.25-.1.25-.25c0-5.17 1.15-10.34 3.44-15.51.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.35 5.17-3.49 10.49-3.49 15.73 0 .13.1.25.25.25s.25-.1.25-.25c0-5.24 1.16-10.49 3.49-15.73.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.38 5.24-3.54 10.63-3.54 15.95 0 .13.1.25.25.25s.25-.1.25-.25c0-5.32 1.18-10.63 3.54-15.95.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.41 5.32-3.59 10.78-3.59 16.17 0 .13.1.25.25.25s.25-.1.25-.25c0-5.39 1.19-10.78 3.59-16.17.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.44 5.39-3.64 10.93-3.64 16.39 0 .13.1.25.25.25s.25-.1.25-.25c0-5.46 1.21-10.93 3.64-16.39.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.48 5.46-3.69 11.07-3.69 16.61 0 .13.1.25.25.25s.25-.1.25-.25c0-5.54 1.23-11.07 3.69-16.61.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.51 5.54-3.74 11.22-3.74 16.83 0 .13.1.25.25.25s.25-.1.25-.25c0-5.61 1.24-11.22 3.74-16.83.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.54 5.61-3.79 11.37-3.79 17.05 0 .13.1.25.25.25s.25-.1.25-.25c0-5.68 1.26-11.37 3.79-17.05.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.57 5.68-3.84 11.51-3.84 17.27 0 .13.1.25.25.25s.25-.1.25-.25c0-5.76 1.28-11.51 3.84-17.27.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.61 5.76-3.89 11.66-3.89 17.49 0 .13.1.25.25.25s.25-.1.25-.25c0-5.83 1.29-11.66 3.89-17.49.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.64 5.83-3.94 11.81-3.94 17.71 0 .13.1.25.25.25s.25-.1.25-.25c0-5.9 1.31-11.81 3.94-17.71.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.67 5.9-3.99 11.95-3.99 17.93 0 .13.1.25.25.25s.25-.1.25-.25c0-5.98 1.33-11.95 3.99-17.93.13-.25.05-.56-.2-.71s-.56-.05-.71.2c-2.7 5.98-4.04 12.1-4.04 18.15 0 .13.1.25.25.25s.25-.1.25-.25c0-6.05 1.34-12.1 4.04-18.15z"
      />
    </svg>
);

const WHATSAPP_NUMBER = '918638098776';

type UserProfile = {
    firstName: string;
    lastName: string;
};

export function FloatingWhatsAppButton() {
    const { user, isUserLoading } = useUser();
    const firestore = useFirestore();
    const [isOpen, setIsOpen] = useState(false);

    const userDocRef = useMemoFirebase(
        () => (user && !user.isAnonymous ? doc(firestore, 'users', user.uid) : null),
        [firestore, user]
    );
    const { data: userData } = useDoc<UserProfile>(userDocRef);

    const baseMessage = useMemo(() => {
        let message = "";
        if (user && !user.isAnonymous && userData) {
            const name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            if (name) {
                message += `\n\nName: ${name}`;
            }
            if (user.email) {
                message += `\nEmail: ${user.email}`;
            }
        }
        return message;
    }, [user, userData]);

    const templates = [
        {
            icon: MessageSquare,
            title: 'Product Quality',
            message: `Hello, I have a question about product quality.${baseMessage}`
        },
        {
            icon: Sparkles,
            title: 'Custom Order',
            message: `Hello, I would like to inquire about a custom order.${baseMessage}`
        }
    ];

    const generateWhatsAppLink = (message: string) => `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;

    return (
        <Popover open={isOpen} onOpenChange={setIsOpen}>
            <PopoverTrigger asChild>
                 <Button
                    className="fixed bottom-6 right-6 h-16 w-16 rounded-full bg-green-500 text-white shadow-lg hover:bg-green-600 focus:ring-2 focus:ring-green-400 focus:ring-offset-2 z-50"
                >
                    {isOpen ? <X className="h-8 w-8" /> : <WhatsAppIcon />}
                    <span className="sr-only">Contact us on WhatsApp</span>
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-80 mr-4 mb-2 p-2" side="top" align="end">
                <div className="space-y-2">
                    <h4 className="font-medium leading-none px-2 pt-2">Hello!</h4>
                    <p className="text-sm text-muted-foreground px-2">
                        How can we help you today?
                    </p>
                </div>
                <div className="grid gap-1 mt-2">
                    {templates.map((template) => (
                        <Link href={generateWhatsAppLink(template.message)} target="_blank" rel="noopener noreferrer" key={template.title}>
                            <Button variant="ghost" className="w-full justify-start">
                                <template.icon className="mr-2 h-4 w-4" />
                                {template.title}
                            </Button>
                        </Link>
                    ))}
                </div>
            </PopoverContent>
        </Popover>
    );
}

    